name: Build LaTeX document

on:
  push:
    branches-ignore:
      - compiled-pdf
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: latex-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_latex:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compile LaTeX document
        uses: xu-cheng/latex-action@v4
        with:
          root_file: dissertation.tex
          latexmk_use_lualatex: true
          latexmk_shell_escape: true
          work_in_root_file_dir: true
          extra_system_packages: inkscape
          args: -pdf -jobname=Thesis -file-line-error -halt-on-error -interaction=nonstopmode

      - name: Verify output exists
        run: |
          ls -lah
          test -f Thesis.pdf
          echo "Found Thesis.pdf"

      - name: Publish PDF to compiled-pdf branch
        if: ${{ github.event_name == 'push' && github.ref != 'refs/heads/compiled-pdf' }}
        run: |
          set -euo pipefail

          BRANCH="compiled-pdf"
          SRC_SHA="${GITHUB_SHA}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          cp -f Thesis.pdf /tmp/Thesis.pdf

          git fetch origin "${BRANCH}" || true
          if git show-ref --verify --quiet "refs/remotes/origin/${BRANCH}"; then
            git switch "${BRANCH}"
          else
            git switch --orphan "${BRANCH}"
          fi

          git rm -rf . >/dev/null 2>&1 || true
          git clean -fdx

          cp -f /tmp/Thesis.pdf Thesis.pdf
          cat > README.md <<EOF
          This branch stores the latest compiled PDF.
          Source commit: ${SRC_SHA}
          Updated by GitHub Actions.
          EOF

          git add Thesis.pdf README.md
          git commit -m "Update Thesis.pdf from ${SRC_SHA}" || true
          git push -f origin "${BRANCH}"

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v5
        with:
          name: PDF
          path: Thesis.pdf