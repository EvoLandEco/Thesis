name: Build LaTeX document

on:
  push:
    branches-ignore:
      - compiled-pdf
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: latex-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_latex:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compile LaTeX document
        uses: xu-cheng/latex-action@v4
        with:
          root_file: dissertation.tex
          latexmk_use_lualatex: true
          latexmk_shell_escape: true
          work_in_root_file_dir: true
          extra_system_packages: inkscape
          args: -pdf -jobname=Thesis -file-line-error -halt-on-error -interaction=nonstopmode

      - name: Verify output exists
        run: |
          ls -lah
          test -f Thesis.pdf

      - name: Publish PDF to compiled-pdf branch
        if: ${{ github.event_name == 'push' && github.ref != 'refs/heads/compiled-pdf' }}
        env:
          BRANCH: compiled-pdf
          SRC_SHA: ${{ github.sha }}
          REPO: ${{ github.repository }}
          TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          REPO_URL="https://x-access-token:${TOKEN}@github.com/${REPO}.git"
          DIR="$(mktemp -d)"

          if git ls-remote --exit-code --heads "${REPO_URL}" "${BRANCH}" >/dev/null 2>&1; then
            git clone --depth 1 --branch "${BRANCH}" "${REPO_URL}" "${DIR}"
          else
            git clone --depth 1 "${REPO_URL}" "${DIR}"
            cd "${DIR}"
            git checkout --orphan "${BRANCH}"
            git rm -rf . >/dev/null 2>&1 || true
          fi

          cd "${DIR}"

          chmod -R u+w . || true
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

          cp -f "${GITHUB_WORKSPACE}/Thesis.pdf" Thesis.pdf
          printf "This branch stores the latest compiled PDF.\nSource commit: %s\nUpdated by GitHub Actions.\n" "${SRC_SHA}" > README.md

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add Thesis.pdf README.md
          git commit -m "Update Thesis.pdf from ${SRC_SHA}" || true
          git push -f origin "${BRANCH}"

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v5
        with:
          name: PDF
          path: Thesis.pdf